<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin-top: 30px; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; font-weight: bold; }
        .table { background-color: white; }
        .btn-group .btn { margin: 0 2px; }
        .navbar { background: linear-gradient(135deg, #007bff, #0056b3); }
        .navbar-brand { color: white !important; font-weight: bold; }
        .nav-link { color: rgba(255,255,255,0.8) !important; }
        .nav-link:hover { color: white !important; }
        .price { font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">üè™ QU·∫¢N L√ù C·ª¨A H√ÄNG</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="categories.html">üì¶ Danh m·ª•c</a>
                <a class="nav-link active" href="products.html">üõçÔ∏è S·∫£n ph·∫©m</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1>üõçÔ∏è QU·∫¢N L√ù S·∫¢N PH·∫®M</h1>
            <p class="text-muted">Th√™m, s·ª≠a, x√≥a c√°c s·∫£n ph·∫©m trong c·ª≠a h√†ng</p>
        </div>

        <!-- Add/Edit Form -->
        <div class="card">
            <div class="card-header">
                <h5 id="formTitle">‚ûï Th√™m s·∫£n ph·∫©m m·ªõi</h5>
            </div>
            <div class="card-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">T√™n s·∫£n ph·∫©m <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Gi√° (VNƒê) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productPrice" min="0" step="1000" required placeholder="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">M√¥ t·∫£</label>
                            <input type="text" class="form-control" id="productDescription" placeholder="M√¥ t·∫£ s·∫£n ph·∫©m">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Danh m·ª•c <span class="text-danger">*</span></label>
                            <select class="form-control" id="productCategory" required>
                                <option value="">Ch·ªçn danh m·ª•c</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" id="btnSave" onclick="saveProduct()">
                                    ‚ûï Th√™m
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <button type="button" class="btn btn-secondary btn-sm" id="btnCancel" onclick="cancelEdit()" style="display: none;">
                                ‚ùå H·ªßy ch·ªânh s·ª≠a
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Products List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üìã Danh s√°ch s·∫£n ph·∫©m</h5>
                <div>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshData()">üîÑ L√†m m·ªõi</button>
                    <span class="badge bg-light text-dark ms-2">T·ªïng: <span id="totalCount">0</span></span>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchInput" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." onkeyup="searchProducts()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="categoryFilter" onchange="filterByCategory()">
                            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="priceFilter" onchange="filterByPrice()">
                            <option value="">T·∫•t c·∫£ gi√°</option>
                            <option value="0-100000">D∆∞·ªõi 100k</option>
                            <option value="100000-500000">100k - 500k</option>
                            <option value="500000-1000000">500k - 1M</option>
                            <option value="1000000-999999999">Tr√™n 1M</option>
                        </select>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th style="width: 120px;">Gi√°</th>
                                <th>M√¥ t·∫£</th>
                                <th style="width: 120px;">Danh m·ª•c</th>
                                <th style="width: 200px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="productsList">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const API_URL = 'https://localhost:7077/api';
        
        // Global variables
        let products = [];
        let categories = [];
        let filteredProducts = [];
        let editingId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            checkCategoryFilter();
        });

        // Check URL for category filter
        function checkCategoryFilter() {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('category');
            if (categoryId) {
                setTimeout(() => {
                    document.getElementById('categoryFilter').value = categoryId;
                    filterByCategory();
                }, 1000);
            }
        }

        // Load all data
        async function loadData() {
            await Promise.all([loadProducts(), loadCategories()]);
            updateDisplay();
        }

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/ProductApi`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                products = await response.json();
                filteredProducts = [...products];
            } catch (error) {
                showToast('L·ªói khi t·∫£i s·∫£n ph·∫©m: ' + error.message, 'danger');
                products = [];
                filteredProducts = [];
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/CategoryApi`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                categories = await response.json();
                updateCategorySelects();
            } catch (error) {
                showToast('L·ªói khi t·∫£i danh m·ª•c: ' + error.message, 'danger');
                categories = [];
            }
        }

        // Update category selects
        function updateCategorySelects() {
            const productSelect = document.getElementById('productCategory');
            const filterSelect = document.getElementById('categoryFilter');
            
            productSelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>';
            filterSelect.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>';
            
            categories.forEach(category => {
                productSelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
                filterSelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        // Update display
        function updateDisplay() {
            displayProducts();
            updateTotalCount();
        }

        // Display products
        function displayProducts() {
            const tbody = document.getElementById('productsList');
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = filteredProducts.map(product => {
                const category = categories.find(c => c.id === product.categoryId);
                return `
                    <tr>
                        <td><strong>#${product.id}</strong></td>
                        <td><strong class="text-primary">${product.name}</strong></td>
                        <td class="price">${formatCurrency(product.price)}</td>
                        <td>${product.description || '<em class="text-muted">Kh√¥ng c√≥ m√¥ t·∫£</em>'}</td>
                        <td>
                            <span class="badge bg-secondary">${category ? category.name : 'N/A'}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-info" onclick="viewProduct(${product.id})" title="Xem chi ti·∫øt">
                                    üëÅÔ∏è Xem
                                </button>
                                <button class="btn btn-outline-warning" onclick="editProduct(${product.id})" title="Ch·ªânh s·ª≠a">
                                    ‚úèÔ∏è S·ª≠a
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})" title="X√≥a">
                                    üóëÔ∏è X√≥a
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Save product (add or update)
        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value.trim();
            const categoryId = parseInt(document.getElementById('productCategory').value);
            
            if (!name) {
                showToast('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m!', 'warning');
                document.getElementById('productName').focus();
                return;
            }
            
            if (!price || price <= 0) {
                showToast('Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá!', 'warning');
                document.getElementById('productPrice').focus();
                return;
            }
            
            if (!categoryId) {
                showToast('Vui l√≤ng ch·ªçn danh m·ª•c!', 'warning');
                document.getElementById('productCategory').focus();
                return;
            }

            const productData = { name, price, description, categoryId };
            
            try {
                let response;
                if (editingId) {
                    // Update
                    productData.id = editingId;
                    response = await fetch(`${API_URL}/ProductApi/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                    if (response.ok) {
                        showToast('C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
                    }
                } else {
                    // Add new
                    response = await fetch(`${API_URL}/ProductApi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                    if (response.ok) {
                        showToast('Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // Reset form and reload
                resetForm();
                loadData();
                
            } catch (error) {
                showToast('L·ªói khi l∆∞u s·∫£n ph·∫©m: ' + error.message, 'danger');
            }
        }

        // Edit product
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingId = id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productCategory').value = product.categoryId;
            
            // Update UI
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a s·∫£n ph·∫©m';
            document.getElementById('btnSave').innerHTML = 'üíæ C·∫≠p nh·∫≠t';
            document.getElementById('btnSave').className = 'btn btn-warning';
            document.getElementById('btnCancel').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('productName').focus();
            
            showToast(`ƒêang ch·ªânh s·ª≠a: ${product.name}`, 'info');
        }

        // View product details
        function viewProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const category = categories.find(c => c.id === product.categoryId);
            const details = `
                <strong>ID:</strong> #${product.id}<br>
                <strong>T√™n:</strong> ${product.name}<br>
                <strong>Gi√°:</strong> ${formatCurrency(product.price)}<br>
                <strong>M√¥ t·∫£:</strong> ${product.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}<br>
                <strong>Danh m·ª•c:</strong> ${category ? category.name : 'Kh√¥ng c√≥ danh m·ª•c'}
            `;

            showToast(`Chi ti·∫øt s·∫£n ph·∫©m:<br>${details}`, 'info');
        }

        // Cancel edit
        function cancelEdit() {
            resetForm();
            showToast('ƒê√£ h·ªßy ch·ªânh s·ª≠a', 'info');
        }

        // Reset form
        function resetForm() {
            editingId = null;
            document.getElementById('productForm').reset();
            document.getElementById('formTitle').textContent = '‚ûï Th√™m s·∫£n ph·∫©m m·ªõi';
            document.getElementById('btnSave').innerHTML = '‚ûï Th√™m';
            document.getElementById('btnSave').className = 'btn btn-primary';
            document.getElementById('btnCancel').style.display = 'none';
        }

        // Delete product
        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m "${product.name}"?`)) return;

            try {
                const response = await fetch(`${API_URL}/ProductApi/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                showToast('X√≥a s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
                loadData();
                
            } catch (error) {
                showToast('L·ªói khi x√≥a s·∫£n ph·∫©m: ' + error.message, 'danger');
            }
        }

        // Search products
        function searchProducts() {
            applyFilters();
        }

        // Filter by category
        function filterByCategory() {
            applyFilters();
        }

        // Filter by price
        function filterByPrice() {
            applyFilters();
        }

        // Apply all filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;

            filteredProducts = products.filter(product => {
                // Search filter
                const matchSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));

                // Category filter
                const matchCategory = !categoryFilter || product.categoryId == categoryFilter;

                // Price filter
                let matchPrice = true;
                if (priceFilter) {
                    const [min, max] = priceFilter.split('-').map(x => parseInt(x));
                    matchPrice = product.price >= min && product.price <= max;
                }

                return matchSearch && matchCategory && matchPrice;
            });

            displayProducts();
            updateTotalCount();
        }

        // Update total count
        function updateTotalCount() {
            document.getElementById('totalCount').textContent = filteredProducts.length;
        }

        // Refresh data
        function refreshData() {
            showToast('ƒêang l√†m m·ªõi d·ªØ li·ªáu...', 'info');
            loadData();
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'danger': 'bg-danger', 
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-success';
            
            const toastHTML = `
                <div class="toast ${bgClass} text-white" id="${toastId}" role="alert">
                    <div class="toast-body">
                        ${message}
                        <button type="button" class="btn-close btn-close-white float-end" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
            toast.show();
            
            // Remove element after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>