<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; color: #495057; }
        .container { max-width: 1200px; margin-top: 20px; }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; background-color: white; border-radius: 10px; }
        .card-header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; font-weight: bold; border-radius: 10px 10px 0 0; }
        .navbar { background: linear-gradient(135deg, #495057, #6c757d); }
        .navbar-brand, .nav-link { color: white !important; }
        .nav-link:hover { color: #adb5bd !important; }
        .btn-group .btn { margin: 0 2px; }
        .stats-row { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e9ecef; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: bold; color: #007bff; }
        .stat-label { color: #6c757d; font-size: 1rem; margin-top: 5px; }
        .table { background-color: white; color: #495057; }
        .table-dark { background-color: #495057; color: white; }
        .form-control { background-color: #f8f9fa; border: 2px solid #e9ecef; color: #495057; border-radius: 8px; }
        .form-control:focus { background-color: white; border-color: #007bff; color: #495057; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        .form-control::placeholder { color: #adb5bd; }
        .btn-primary { background-color: #007bff; border-color: #007bff; border-radius: 8px; }
        .btn-warning { background-color: #ffc107; border-color: #ffc107; color: #212529; border-radius: 8px; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; border-radius: 8px; }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; border-radius: 8px; }
        .btn-outline-secondary { color: #6c757d; border-color: #6c757d; border-radius: 8px; }
        .btn-outline-secondary:hover { background-color: #6c757d; border-color: #6c757d; color: white; }
        .text-muted { color: #6c757d !important; }
        .text-primary { color: #007bff !important; }
        .badge.bg-secondary { background-color: #6c757d !important; }
        .price { font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">üè™ C·ª≠a h√†ng</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="categories.html">üì¶ Danh m·ª•c</a>
                <a class="nav-link active" href="products.html">üõçÔ∏è S·∫£n ph·∫©m</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1>üõçÔ∏è QU·∫¢N L√ù S·∫¢N PH·∫®M</h1>
            <p class="text-muted">Th√™m, s·ª≠a, x√≥a s·∫£n ph·∫©m trong c·ª≠a h√†ng</p>
        </div>

        <!-- Statistics -->
        <div class="stats-row">
            <div class="row">
                <div class="col-md-4 stat-item">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div class="stat-label">T·ªïng s·∫£n ph·∫©m</div>
                </div>
                <div class="col-md-4 stat-item">
                    <div class="stat-number" id="totalValue">0ƒë</div>
                    <div class="stat-label">T·ªïng gi√° tr·ªã</div>
                </div>
                <div class="col-md-4 stat-item">
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshData()">üîÑ L√†m m·ªõi</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Form -->
        <div class="card">
            <div class="card-header">
                <h5 id="formTitle">‚ûï Th√™m s·∫£n ph·∫©m m·ªõi</h5>
            </div>
            <div class="card-body">
                <form id="productForm">
                    <input type="hidden" id="editingId">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="productName" placeholder="T√™n s·∫£n ph·∫©m *" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="productPrice" placeholder="Gi√° (VNƒê) *" min="0" step="1000" required>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="productDescription" placeholder="M√¥ t·∫£ s·∫£n ph·∫©m">
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="productCategory" required>
                                <option value="">Ch·ªçn danh m·ª•c</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary w-100" id="btnSave" onclick="saveProduct()">
                                ‚ûï Th√™m
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-secondary btn-sm" id="btnCancel" onclick="cancelEdit()" style="display: none;">
                            ‚ùå H·ªßy
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchInput" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." onkeyup="searchProducts()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="categoryFilter" onchange="filterByCategory()">
                            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="priceFilter" onchange="filterByPrice()">
                            <option value="">T·∫•t c·∫£ gi√°</option>
                            <option value="0-100000">D∆∞·ªõi 100k</option>
                            <option value="100000-500000">100k - 500k</option>
                            <option value="500000-1000000">500k - 1M</option>
                            <option value="1000000-999999999">Tr√™n 1M</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card">
            <div class="card-header">
                <h5>üìã Danh s√°ch s·∫£n ph·∫©m</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th style="width: 120px;">Gi√°</th>
                                <th>M√¥ t·∫£</th>
                                <th style="width: 120px;">Danh m·ª•c</th>
                                <th style="width: 180px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="productsList">
                            <tr>
                                <td colspan="6" class="text-center">üîÑ ƒêang t·∫£i d·ªØ li·ªáu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://localhost:7077/api';
        let products = [];
        let categories = [];
        let filteredProducts = [];
        let editingId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);

        // Load all data
        async function loadData() {
            try {
                const [productsRes, categoriesRes] = await Promise.all([
                    fetch(`${API_URL}/ProductApi`),
                    fetch(`${API_URL}/CategoryApi`)
                ]);
                
                products = await productsRes.json();
                categories = await categoriesRes.json();
                filteredProducts = [...products];
                
                updateDisplay();
                updateStats();
                updateCategorySelects();
            } catch (error) {
                showError('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
            }
        }

        // Update category selects
        function updateCategorySelects() {
            const productSelect = document.getElementById('productCategory');
            const filterSelect = document.getElementById('categoryFilter');
            
            productSelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>';
            filterSelect.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>';
            
            categories.forEach(category => {
                productSelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
                filterSelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        // Update display
        function updateDisplay() {
            const tbody = document.getElementById('productsList');
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = filteredProducts.map(product => {
                const category = categories.find(c => c.id === product.categoryId);
                return `
                    <tr>
                        <td><strong>#${product.id}</strong></td>
                        <td><strong class="text-primary">${product.name}</strong></td>
                        <td class="price">${formatCurrency(product.price)}</td>
                        <td>${product.description || '<em class="text-muted">Kh√¥ng c√≥</em>'}</td>
                        <td>
                            <span class="badge bg-secondary">${category ? category.name : 'N/A'}</span>
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewProduct(${product.id})" title="Xem">
                                üëÅÔ∏è
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editProduct(${product.id})" title="S·ª≠a">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})" title="X√≥a">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update statistics
        function updateStats() {
            const totalProds = products.length;
            const totalVal = products.reduce((sum, product) => sum + (product.price || 0), 0);

            document.getElementById('totalProducts').textContent = totalProds;
            document.getElementById('totalValue').textContent = formatCurrency(totalVal);
        }

        // Save product
        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value.trim();
            const categoryId = parseInt(document.getElementById('productCategory').value);
            
            if (!name || !price || !categoryId) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                const data = { name, price, description, categoryId };
                let response;

                if (editingId) {
                    data.id = editingId;
                    response = await fetch(`${API_URL}/ProductApi/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                } else {
                    response = await fetch(`${API_URL}/ProductApi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    alert('Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!');
                }

                if (!response.ok) throw new Error('L·ªói API');
                
                resetForm();
                loadData();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }

        // Edit product
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingId = id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productCategory').value = product.categoryId;
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a s·∫£n ph·∫©m';
            document.getElementById('btnSave').innerHTML = 'üíæ C·∫≠p nh·∫≠t';
            document.getElementById('btnSave').className = 'btn btn-warning w-100';
            document.getElementById('btnCancel').style.display = 'inline-block';
        }

        // View product
        function viewProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const category = categories.find(c => c.id === product.categoryId);
            const details = `ID: #${product.id}\nT√™n: ${product.name}\nGi√°: ${formatCurrency(product.price)}\nM√¥ t·∫£: ${product.description || 'Kh√¥ng c√≥'}\nDanh m·ª•c: ${category ? category.name : 'N/A'}`;
            alert(details);
        }

        // Delete product
        async function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (!confirm(`X√≥a s·∫£n ph·∫©m "${product.name}"?`)) return;

            try {
                const response = await fetch(`${API_URL}/ProductApi/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('L·ªói API');
                
                alert('X√≥a th√†nh c√¥ng!');
                loadData();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;

            filteredProducts = products.filter(product => {
                const matchSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));

                const matchCategory = !categoryFilter || product.categoryId == categoryFilter;

                let matchPrice = true;
                if (priceFilter) {
                    const [min, max] = priceFilter.split('-').map(x => parseInt(x));
                    matchPrice = product.price >= min && product.price <= max;
                }

                return matchSearch && matchCategory && matchPrice;
            });

            updateDisplay();
        }

        // Search products
        function searchProducts() { applyFilters(); }
        function filterByCategory() { applyFilters(); }
        function filterByPrice() { applyFilters(); }

        // Cancel edit
        function cancelEdit() { resetForm(); }

        // Reset form
        function resetForm() {
            editingId = null;
            document.getElementById('productForm').reset();
            document.getElementById('formTitle').textContent = '‚ûï Th√™m s·∫£n ph·∫©m m·ªõi';
            document.getElementById('btnSave').innerHTML = '‚ûï Th√™m';
            document.getElementById('btnSave').className = 'btn btn-primary w-100';
            document.getElementById('btnCancel').style.display = 'none';
        }

        // Refresh data
        function refreshData() {
            loadData();
            const btn = event.target;
            btn.textContent = '‚è≥ ƒêang t·∫£i...';
            setTimeout(() => btn.textContent = 'üîÑ L√†m m·ªõi', 1000);
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Show error
        function showError(message) {
            document.getElementById('productsList').innerHTML = 
                `<tr><td colspan="6" class="text-center text-danger">${message}</td></tr>`;
        }
    </script>
</body>
</html>