<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Danh m·ª•c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .container { max-width: 1000px; margin-top: 30px; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold; }
        .table { background-color: white; }
        .btn-group .btn { margin: 0 2px; }
        .navbar { background: linear-gradient(135deg, #007bff, #0056b3); }
        .navbar-brand { color: white !important; font-weight: bold; }
        .nav-link { color: rgba(255,255,255,0.8) !important; }
        .nav-link:hover { color: white !important; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">üè™ QU·∫¢N L√ù C·ª¨A H√ÄNG</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="categories.html">üì¶ Danh m·ª•c</a>
                <a class="nav-link" href="products.html">üõçÔ∏è S·∫£n ph·∫©m</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1>üì¶ QU·∫¢N L√ù DANH M·ª§C</h1>
            <p class="text-muted">Th√™m, s·ª≠a, x√≥a c√°c danh m·ª•c s·∫£n ph·∫©m</p>
        </div>

        <!-- Add/Edit Form -->
        <div class="card">
            <div class="card-header">
                <h5 id="formTitle">‚ûï Th√™m danh m·ª•c m·ªõi</h5>
            </div>
            <div class="card-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">T√™n danh m·ª•c <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="categoryName" required placeholder="Nh·∫≠p t√™n danh m·ª•c">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">M√¥ t·∫£</label>
                            <input type="text" class="form-control" id="categoryDescription" placeholder="M√¥ t·∫£ v·ªÅ danh m·ª•c">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-success" id="btnSave" onclick="saveCategory()">
                                    ‚ûï Th√™m
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <button type="button" class="btn btn-secondary btn-sm" id="btnCancel" onclick="cancelEdit()" style="display: none;">
                                ‚ùå H·ªßy ch·ªânh s·ª≠a
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Categories List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üìã Danh s√°ch danh m·ª•c</h5>
                <div>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshData()">üîÑ L√†m m·ªõi</button>
                    <span class="badge bg-light text-dark ms-2">T·ªïng: <span id="totalCount">0</span></span>
                </div>
            </div>
            <div class="card-body">
                <!-- Search -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchInput" placeholder="üîç T√¨m ki·∫øm danh m·ª•c..." onkeyup="searchCategories()">
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th>T√™n danh m·ª•c</th>
                                <th>M√¥ t·∫£</th>
                                <th style="width: 120px;">S·ªë s·∫£n ph·∫©m</th>
                                <th style="width: 200px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesList">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const API_URL = 'https://localhost:7077/api';
        
        // Global variables
        let categories = [];
        let products = [];
        let editingId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // Load all data
        async function loadData() {
            await Promise.all([loadCategories(), loadProducts()]);
            updateDisplay();
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/CategoryApi`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                categories = await response.json();
            } catch (error) {
                showToast('L·ªói khi t·∫£i danh m·ª•c: ' + error.message, 'danger');
                categories = [];
            }
        }

        // Load products for counting
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/ProductApi`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                products = await response.json();
            } catch (error) {
                products = [];
            }
        }

        // Update display
        function updateDisplay() {
            displayCategories();
            updateTotalCount();
        }

        // Display categories
        function displayCategories() {
            const tbody = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ danh m·ª•c n√†o</td></tr>';
                return;
            }

            tbody.innerHTML = categories.map(category => {
                const productCount = products.filter(p => p.categoryId === category.id).length;
                return `
                    <tr>
                        <td><strong>#${category.id}</strong></td>
                        <td><strong class="text-primary">${category.name}</strong></td>
                        <td>${category.description || '<em class="text-muted">Kh√¥ng c√≥ m√¥ t·∫£</em>'}</td>
                        <td class="text-center">
                            <span class="badge bg-info">${productCount} SP</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="viewProducts(${category.id})" title="Xem s·∫£n ph·∫©m">
                                    üëÅÔ∏è Xem
                                </button>
                                <button class="btn btn-outline-warning" onclick="editCategory(${category.id})" title="Ch·ªânh s·ª≠a">
                                    ‚úèÔ∏è S·ª≠a
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCategory(${category.id})" title="X√≥a">
                                    üóëÔ∏è X√≥a
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Save category (add or update)
        async function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            
            if (!name) {
                showToast('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!', 'warning');
                document.getElementById('categoryName').focus();
                return;
            }

            // Check duplicate name
            const existingCategory = categories.find(c => 
                c.name.toLowerCase() === name.toLowerCase() && c.id !== editingId
            );
            if (existingCategory) {
                showToast('T√™n danh m·ª•c ƒë√£ t·ªìn t·∫°i!', 'warning');
                return;
            }

            const categoryData = { name, description };
            
            try {
                let response;
                if (editingId) {
                    // Update
                    categoryData.id = editingId;
                    response = await fetch(`${API_URL}/CategoryApi/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(categoryData)
                    });
                    if (response.ok) {
                        showToast('C·∫≠p nh·∫≠t danh m·ª•c th√†nh c√¥ng!', 'success');
                    }
                } else {
                    // Add new
                    response = await fetch(`${API_URL}/CategoryApi`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(categoryData)
                    });
                    if (response.ok) {
                        showToast('Th√™m danh m·ª•c th√†nh c√¥ng!', 'success');
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // Reset form and reload
                resetForm();
                loadData();
                
            } catch (error) {
                showToast('L·ªói khi l∆∞u danh m·ª•c: ' + error.message, 'danger');
            }
        }

        // Edit category
        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;

            editingId = id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
            
            // Update UI
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a danh m·ª•c';
            document.getElementById('btnSave').innerHTML = 'üíæ C·∫≠p nh·∫≠t';
            document.getElementById('btnSave').className = 'btn btn-warning';
            document.getElementById('btnCancel').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('categoryForm').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('categoryName').focus();
            
            showToast(`ƒêang ch·ªânh s·ª≠a: ${category.name}`, 'info');
        }

        // Cancel edit
        function cancelEdit() {
            resetForm();
            showToast('ƒê√£ h·ªßy ch·ªânh s·ª≠a', 'info');
        }

        // Reset form
        function resetForm() {
            editingId = null;
            document.getElementById('categoryForm').reset();
            document.getElementById('formTitle').textContent = '‚ûï Th√™m danh m·ª•c m·ªõi';
            document.getElementById('btnSave').innerHTML = '‚ûï Th√™m';
            document.getElementById('btnSave').className = 'btn btn-success';
            document.getElementById('btnCancel').style.display = 'none';
        }

        // Delete category
        async function deleteCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;

            // Check if category has products
            const productCount = products.filter(p => p.categoryId === id).length;
            if (productCount > 0) {
                showToast(`Kh√¥ng th·ªÉ x√≥a danh m·ª•c "${category.name}" v√¨ c√≤n ${productCount} s·∫£n ph·∫©m!`, 'warning');
                return;
            }

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh m·ª•c "${category.name}"?`)) return;

            try {
                const response = await fetch(`${API_URL}/CategoryApi/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                showToast('X√≥a danh m·ª•c th√†nh c√¥ng!', 'success');
                loadData();
                
            } catch (error) {
                showToast('L·ªói khi x√≥a danh m·ª•c: ' + error.message, 'danger');
            }
        }

        // View products in category
        function viewProducts(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const categoryProducts = products.filter(p => p.categoryId === categoryId);
            
            if (categoryProducts.length === 0) {
                showToast(`Danh m·ª•c "${category.name}" ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!`, 'info');
            } else {
                window.open(`products.html?category=${categoryId}`, '_blank');
            }
        }

        // Search categories
        function searchCategories() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#categoriesList tr');
            
            rows.forEach(row => {
                if (row.cells.length > 1) {
                    const name = row.cells[1].textContent.toLowerCase();
                    const description = row.cells[2].textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || description.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // Update total count
        function updateTotalCount() {
            document.getElementById('totalCount').textContent = categories.length;
        }

        // Refresh data
        function refreshData() {
            showToast('ƒêang l√†m m·ªõi d·ªØ li·ªáu...', 'info');
            loadData();
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'danger': 'bg-danger', 
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-success';
            
            const toastHTML = `
                <div class="toast ${bgClass} text-white" id="${toastId}" role="alert">
                    <div class="toast-body">
                        ${message}
                        <button type="button" class="btn-close btn-close-white float-end" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Remove element after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>